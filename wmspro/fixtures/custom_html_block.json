[
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<div id=\"oms-root\">\n\n  <div class=\"dash-header\">\n    <h3>OMS Requisition Order Dashboard</h3>\n    <div id=\"record-count\">0 records</div>\n  </div>\n\n  <div class=\"dash-bar\">\n  <button id=\"action-btn\" class=\"action-btn\" disabled>\n    Action\n  </button>\n\n  <select id=\"status-filter\">\n    <option value=\"All\">All Status</option>\n    <option value=\"Draft\">Draft</option>\n    <option value=\"Approved\">Approved</option>\n    <option value=\"Submit\">Submit</option>\n  </select>\n\n  <select id=\"sort-order\">\n    <option value=\"desc\">Newest First</option>\n    <option value=\"asc\">Oldest First</option>\n  </select>\n</div>\n    \n    </div> \n  <table class=\"dash-table\">\n    <thead>\n      <tr>\n        <th>ID</th>\n        <th>Date</th>\n        <th>Requesting Facility</th>\n        <th>Status</th>\n        <th style=\"text-align:center\">View</th>\n      </tr>\n    </thead>\n    <tbody id=\"table-body\"></tbody>\n  </table>\n\n</div>\n\n<!-- POPUP -->\n<div id=\"popup\" class=\"popup hidden\">\n  <div class=\"popup-backdrop\"></div>\n  <div class=\"popup-box\">\n    <div class=\"popup-header\">\n      <h4 id=\"popup-title\"></h4>\n      <button id=\"popup-close\">‚úï</button>\n    </div>\n    <div class=\"popup-body\" id=\"popup-body\"></div>\n  </div>\n</div>",
  "modified": "2026-02-20 12:56:05.620988",
  "name": "OMS Requisition Order Dashboard",
  "private": 0,
  "roles": [
   {
    "parent": "OMS Requisition Order Dashboard",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "L2"
   },
   {
    "parent": "OMS Requisition Order Dashboard",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "L3"
   },
   {
    "parent": "OMS Requisition Order Dashboard",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "L1"
   }
  ],
  "script": "(() => {\n  const root = root_element;\n\n  /* ================= ELEMENTS ================= */\n  const tbody = root.querySelector('#table-body');\n  const countEl = root.querySelector('#record-count');\n  const statusFilter = root.querySelector('#status-filter');\n  const sortOrder = root.querySelector('#sort-order');\n  const actionBtn = root.querySelector('#action-btn');\n\n  // POPUP\n  const popup = root.querySelector('#popup');\n  const popupBody = root.querySelector('#popup-body');\n  const popupTitle = root.querySelector('#popup-title');\n  const popupClose = root.querySelector('#popup-close');\n  const popupBackdrop = root.querySelector('.popup-backdrop');\n\n  /* ================= STATE ================= */\n  let allDocs = [];\n  let visibleDocs = [];\n  let selected = new Set();\n\n  const userRoles = frappe.user_roles || [];\n  const isL1 = userRoles.includes('L1');\n  const isL2 = userRoles.includes('L2');\n  const isL3 = userRoles.includes('L3');\n\n  /* ================= POPUP CLOSE ================= */\n  popupClose.onclick = () => popup.classList.add('hidden');\n  popupBackdrop.onclick = () => popup.classList.add('hidden');\n\n  /* ================= WORKFLOW CONFIG ================= */\n\n  function getActionConfig(docs) {\n    if (!docs.length) return null;\n\n    const states = new Set(docs.map(d => d.workflow_state));\n    if (states.size > 1) return null; // ‚ùå mixed states\n\n    const state = docs[0].workflow_state;\n\n    // L1 or L2 ‚Üí Draft ‚Üí Approved\n    if ((isL1 || isL2) && state === 'Draft') {\n      return {\n        label: 'Request For Approval'\n      };\n    }\n\n    // L3 ‚Üí Approved ‚Üí Submit\n    if (isL3 && state === 'Approved') {\n      return {\n        label: 'Submit'\n      };\n    }\n\n    return null;\n  }\n\n  /* ================= ACTION BUTTON ================= */\n\n  function updateActionButton() {\n    if (selected.size === 0) {\n      actionBtn.disabled = true;\n      actionBtn.innerText = 'Action';\n      actionBtn.title = '';\n      return;\n    }\n\n    const docs = [...selected].map(\n      name => allDocs.find(d => d.name === name)\n    );\n\n    const states = new Set(docs.map(d => d.workflow_state));\n    if (states.size > 1) {\n      actionBtn.disabled = true;\n      actionBtn.innerText = 'Action';\n      actionBtn.title = 'Mixed status selection not allowed';\n      return;\n    }\n\n    const config = getActionConfig(docs);\n\n    if (!config) {\n      actionBtn.disabled = true;\n      actionBtn.innerText = 'Action';\n      actionBtn.title = 'No action available for your role';\n      return;\n    }\n\n    actionBtn.disabled = false;\n    actionBtn.innerText = config.label;\n    actionBtn.title = '';\n  }\n\n  /* ================= TABLE ================= */\n\n  function renderTable() {\n    tbody.innerHTML = '';\n    selected.clear();\n\n    visibleDocs.forEach(doc => {\n      tbody.insertAdjacentHTML('beforeend', `\n        <tr>\n          <td>\n            <input type=\"checkbox\" data-name=\"${doc.name}\">\n            <a href=\"#\" class=\"req-link\" data-name=\"${doc.name}\">\n              ${doc.name}\n            </a>\n          </td>\n          <td>${frappe.format(doc.request_date,{ fieldtype:'Date' })}</td>\n          <td>${doc.requesting_facility || '-'}</td>\n          <td>\n            <span class=\"status ${doc.workflow_state}\">\n              ${doc.workflow_state}\n            </span>\n          </td>\n          <td style=\"text-align:center\">\n            <button class=\"view-btn\" data-name=\"${doc.name}\">üëÅ</button>\n          </td>\n        </tr>\n      `);\n    });\n\n    countEl.innerText = `${visibleDocs.length} records`;\n\n    // Navigate to form\n    root.querySelectorAll('.req-link').forEach(a => {\n      a.onclick = e => {\n        e.preventDefault();\n        frappe.set_route(\n          'Form',\n          'OMS Requisition Order',\n          a.dataset.name\n        );\n      };\n    });\n\n    // Checkbox handling\n    root.querySelectorAll('input[type=\"checkbox\"]').forEach(cb => {\n      cb.onchange = () => {\n        cb.checked\n          ? selected.add(cb.dataset.name)\n          : selected.delete(cb.dataset.name);\n        updateActionButton();\n      };\n    });\n\n    // View popup\n    root.querySelectorAll('.view-btn').forEach(btn => {\n      btn.onclick = () => openPopup(btn.dataset.name);\n    });\n\n    updateActionButton();\n  }\n\n  /* ================= POPUP ================= */\n\n  async function openPopup(name) {\n    try {\n      const doc = await frappe.db.get_doc('OMS Requisition Order', name);\n      popupTitle.innerText = `Requisition ${doc.name}`;\n\n      let itemRows = '';\n      if (doc.items && doc.items.length) {\n        doc.items.forEach(item => {\n          const qty =\n            item.quantity_requested ??\n            item.qty_requested ??\n            item.requested_qty ??\n            item.qty ??\n            item.quantity ??\n            0;\n\n          itemRows += `\n            <tr>\n              <td>${item.item_name || item.item_code || '-'}</td>\n              <td class=\"qty\">${qty}</td>\n            </tr>\n          `;\n        });\n      } else {\n        itemRows = `\n          <tr>\n            <td colspan=\"2\" style=\"text-align:center;color:#6b7280;\">\n              No items found\n            </td>\n          </tr>\n        `;\n      }\n\n      popupBody.innerHTML = `\n        <div class=\"detail-grid\">\n          <div class=\"detail\"><label>Company</label><span>${doc.company}</span></div>\n          <div class=\"detail\"><label>Type</label><span>${doc.requisition_type}</span></div>\n          <div class=\"detail\"><label>Priority</label><span>${doc.priority}</span></div>\n          <div class=\"detail\"><label>Request Date</label>\n            <span>${frappe.format(doc.request_date,{fieldtype:'Date'})}</span>\n          </div>\n          <div class=\"detail\"><label>Required By</label>\n            <span>${frappe.format(doc.required_by_date,{fieldtype:'Date'})}</span>\n          </div>\n          <div class=\"detail\"><label>Requesting Facility</label>\n            <span>${doc.requesting_facility}</span>\n          </div>\n        </div>\n\n        <table class=\"items-table\">\n          <thead>\n            <tr>\n              <th>Item</th>\n              <th class=\"qty\">Quantity Requested</th>\n            </tr>\n          </thead>\n          <tbody>${itemRows}</tbody>\n        </table>\n      `;\n\n      popup.classList.remove('hidden');\n    } catch (err) {\n      console.error(err);\n      frappe.msgprint('Failed to load requisition details');\n    }\n  }\n\n  /* ================= ACTION EXECUTION ================= */\n\n  actionBtn.onclick = async () => {\n    if (selected.size === 0) return;\n\n    const actionName = actionBtn.innerText; // MUST match workflow action\n\n    try {\n      for (const name of selected) {\n        const doc = await frappe.db.get_doc(\n          'OMS Requisition Order',\n          name\n        );\n\n        await frappe.call({\n          method: 'frappe.model.workflow.apply_workflow',\n          args: {\n            doc: doc,\n            action: actionName\n          }\n        });\n      }\n\n      frappe.show_alert({\n        message: `Workflow action \"${actionName}\" applied`,\n        indicator: 'green'\n      });\n\n      selected.clear();\n      loadData();\n    } catch (err) {\n      console.error(err);\n      frappe.msgprint({\n        title: 'Workflow Error',\n        message: err.message || 'Workflow action failed',\n        indicator: 'red'\n      });\n    }\n  };\n\n  /* ================= FILTER + SORT ================= */\n\n  function applyFilters() {\n    visibleDocs =\n      statusFilter.value === 'All'\n        ? [...allDocs]\n        : allDocs.filter(\n            d => d.workflow_state === statusFilter.value\n          );\n\n    visibleDocs.sort((a, b) =>\n      sortOrder.value === 'desc'\n        ? new Date(b.request_date) - new Date(a.request_date)\n        : new Date(a.request_date) - new Date(b.request_date)\n    );\n\n    renderTable();\n  }\n\n  statusFilter.onchange = applyFilters;\n  sortOrder.onchange = applyFilters;\n\n  /* ================= LOAD DATA ================= */\n\n  function loadData() {\n    frappe.call({\n      method: 'frappe.client.get_list',\n      args: {\n        doctype: 'OMS Requisition Order',\n        fields: [\n          'name',\n          'request_date',\n          'requesting_facility',\n          'workflow_state'\n        ],\n        limit_page_length: 200\n      }\n    }).then(r => {\n      allDocs = r.message || [];\n      applyFilters();\n    });\n  }\n\n  loadData();\n})();",
  "style": "#oms-root {\n  font-family: Inter, system-ui, sans-serif;\n}\n\n.dash-header {\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 10px;\n}\n\n.dash-bar {\n  display: flex;\n  gap: 10px;\n  margin-bottom: 10px;\n}\n\n.dash-table {\n  width: 100%;\n  border-collapse: collapse;\n  font-size: 13px;\n}\n\n.dash-table th {\n  background: #f8fafc;\n  padding: 8px;\n  border-bottom: 1px solid #e5e7eb;\n  text-align: left;\n}\n\n.dash-table td {\n  padding: 8px;\n  border-bottom: 1px solid #f1f5f9;\n}\n\n.status {\n  padding: 3px 10px;\n  border-radius: 12px;\n  font-size: 11px;\n  font-weight: 600;\n}\n\n.status.Draft { background: #fee2e2; color: #991b1b; }\n.status.Approved { background: #dcfce7; color: #166534; }\n.status.Submit { background: #e0e7ff; color: #3730a3; }\n\n.view-btn {\n  cursor: pointer;\n  padding: 4px 6px;\n  border: 1px solid #d1d5db;\n  border-radius: 4px;\n  background: #fff;\n}\n\n/* POPUP */\n.popup.hidden { display: none; }\n\n.popup {\n  position: fixed;\n  inset: 0;\n  z-index: 9999;\n}\n\n.popup-backdrop {\n  position: absolute;\n  inset: 0;\n  background: rgba(0,0,0,0.45);\n}\n\n.popup-box {\n  position: relative;\n  width: 70%;\n  max-width: 900px;\n  margin: 5% auto;\n  background: #fff;\n  border-radius: 8px;\n  overflow: hidden;\n}\n\n.popup-header {\n  display: flex;\n  justify-content: space-between;\n  padding: 12px;\n  border-bottom: 1px solid #e5e7eb;\n  background: #f9fafb;\n}\n\n.popup-body {\n  padding: 16px;\n}\n\n.detail-grid {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 14px;\n  margin-bottom: 20px;\n}\n\n.detail label {\n  font-size: 11px;\n  font-weight: 600;\n  color: #6b7280;\n  display: block;\n}\n\n.detail span {\n  font-size: 13px;\n}\n\n.items-table {\n  width: 100%;\n  border-collapse: collapse;\n  font-size: 13px;\n}\n\n.items-table th {\n  background: #f8fafc;\n  padding: 8px;\n  border-bottom: 1px solid #e5e7eb;\n}\n\n.items-table td {\n  padding: 8px;\n  border-bottom: 1px solid #f1f5f9;\n}\n\n.items-table td.qty {\n  text-align: right;\n  font-weight: 600;\n}\n.qty{\n    text-align:right;\n}\n/* ID LINK */\n.req-link {\n  color: #2563eb;\n  text-decoration: none;\n  font-weight: 600;\n}\n\n.req-link:hover {\n  text-decoration: underline;\n}\n.action-btn {\n  background: #2563eb;\n  color: #fff;\n  border: none;\n  padding: 6px 14px;\n  border-radius: 6px;\n  font-weight: 600;\n  cursor: pointer;\n}\n\n.action-btn:disabled {\n  background: #c7c7c7;\n  cursor: not-allowed;\n}"
 }
]